#!/bin/bash
# LaskoBOT macOS Deploy Script
# Quick deploy for development - rebuilds and restarts the service

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
INSTALL_DIR="${LASKOBOT_INSTALL_DIR:-$HOME/.local/lib/laskobot}"
PLIST_NAME="com.laskobot.daemon.plist"
LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"

echo -e "${CYAN}LaskoBOT macOS Deploy${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Check if macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo -e "${RED}Error: This script is for macOS only${NC}"
    echo "Use ./scripts/deploy for Linux"
    exit 1
fi

cd "$PROJECT_DIR"

# Get current version
VERSION=$(grep '"version"' package.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
echo -e "Version: ${CYAN}$VERSION${NC}"

# Build
echo ""
echo -e "${CYAN}Building...${NC}"
npm run build

# Copy to install dir
echo ""
echo -e "${CYAN}Deploying to $INSTALL_DIR...${NC}"

if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${YELLOW}Installation not found. Running full install...${NC}"
    ./scripts/macos/install.sh
    exit 0
fi

# Update dist only (faster than full install)
cp -r dist/* "$INSTALL_DIR/dist/"
echo -e "${GREEN}✓ Updated dist${NC}"

# Restart service
echo ""
echo -e "${CYAN}Restarting service...${NC}"

if launchctl list | grep -q "com.laskobot.daemon"; then
    launchctl kickstart -k "gui/$(id -u)/com.laskobot.daemon" 2>/dev/null || {
        launchctl unload "$LAUNCH_AGENTS_DIR/$PLIST_NAME" 2>/dev/null || true
        launchctl load "$LAUNCH_AGENTS_DIR/$PLIST_NAME"
    }
    echo -e "${GREEN}✓ Service restarted${NC}"
else
    launchctl load "$LAUNCH_AGENTS_DIR/$PLIST_NAME" 2>/dev/null || true
    echo -e "${GREEN}✓ Service started${NC}"
fi

sleep 2

# Check status
echo ""
if launchctl list | grep -q "com.laskobot.daemon"; then
    echo -e "${GREEN}✓ Deploy complete - service running${NC}"
    echo ""
    echo "Logs: tail -f /tmp/laskobot.log"
else
    echo -e "${YELLOW}⚠ Service may not have started${NC}"
    echo "Check: tail -f /tmp/laskobot.err"
fi
